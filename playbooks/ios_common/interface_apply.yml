---
- name: Deploy Universal Interface Configuration
  hosts: platforms_cisco-ios
  gather_facts: no
  become: yes
  become_method: enable
  
  vars_files:
    - "{{ playbook_dir }}/../../host_vars/{{ inventory_hostname }}.yml"
    - "{{ playbook_dir }}/../../group_vars/all.yml"

  pre_tasks:
    - name: "Fix Ansible Host"
      set_fact:
        ansible_host: "{{ primary_ip4 }}"
      when: ansible_host is mapping

    - name: "Build Normalized Interface List"
      set_fact:
        interface_list_json: |
          [
            {% for item in interfaces %}
            {
              "name": {{ item.name | to_json }},
              "description": {{ (item.description | default('Managed by Ansible')) | to_json }},
              "enabled": {{ (item.enabled | default(true)) | to_json }},
              
              {# --- CRITICAL FIX: Handle 'Interface_Role' Capitalization --- #}
              "role": {{ (item.custom_fields.Interface_Role | default('access') | lower) | to_json }},

              {# --- IP ADDRESS --- #}
              "ipv4": {{ (item.ip_addresses[0].address if item.ip_addresses else None) | to_json }},

              {# --- VLANS --- #}
              "access_vlan": {{ (item.untagged_vlan.vid if item.untagged_vlan else None) | to_json }},
              "voice_vlan": {{ item.custom_fields.voice_vlan | to_json }},
              "trunk_vlans": {{ (item.tagged_vlans | map(attribute='vid') | join(',')) | to_json }},
              "native_vlan": {{ (item.untagged_vlan.vid if (item.mode and item.mode.value == 'tagged' and item.untagged_vlan) else None) | to_json }},

              {# --- FEATURES --- #}
              "auth_enabled": {{ (item.custom_fields.auth_enable | default(false)) | to_json }},
              "qos_profile": {{ (item.custom_fields.qos_profile | default('default')) | to_json }}
            }{{ ',' if not loop.last else '' }}
            {% endfor %}
          ]
      run_once: false

    - name: "Finalize Interface List"
      set_fact:
        interface_list: "{{ interface_list_json | from_json if interface_list_json is string else interface_list_json }}"

  roles:
    - ios_common/interface
