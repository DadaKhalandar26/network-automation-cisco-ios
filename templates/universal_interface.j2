{# --- MAP: Convert CIDR to Subnet Mask (Fixes IP Overlap) --- #}
{% set netmask_map = {
    '32': '255.255.255.255',
    '31': '255.255.255.254',
    '30': '255.255.255.252',
    '29': '255.255.255.248',
    '28': '255.255.255.240',
    '27': '255.255.255.224',
    '26': '255.255.255.192',
    '25': '255.255.255.128',
    '24': '255.255.255.0',
    '23': '255.255.254.0',
    '22': '255.255.252.0',
    '21': '255.255.248.0',
    '20': '255.255.240.0',
    '19': '255.255.224.0',
    '18': '255.255.192.0',
    '17': '255.255.128.0',
    '16': '255.255.0.0',
    '8':  '255.0.0.0'
} %}

{% for iface in interface_list %}
!
interface {{ iface.name }}
 {% if iface.description and iface.description | length > 0 %}
 description {{ iface.description }}
 {% endif %}

{# --- ROLE 1: ROUTED PORT (Layer 3) --- #}
{% if iface.ipv4 and 'Vlan' not in iface.name %}
 {# Try L3 config. If switch is L2-only, this line might error but we proceed #}
 no switchport
 {% set ip_val = iface.ipv4.split('/')[0] %}
 {% set cidr_val = iface.ipv4.split('/')[1] %}
 ip address {{ ip_val }} {{ netmask_map[cidr_val] | default('255.255.255.0') }}
 no shutdown

{# --- ROLE 2: SVI (Vlan Interface) --- #}
{% elif iface.ipv4 and 'Vlan' in iface.name %}
 {% set ip_val = iface.ipv4.split('/')[0] %}
 {% set cidr_val = iface.ipv4.split('/')[1] %}
 ip address {{ ip_val }} {{ netmask_map[cidr_val] | default('255.255.255.0') }}
 no shutdown

{# --- ROLE 3: TRUNK / UPLINK --- #}
{% elif iface.mode == 'tagged' or iface.mode == 'trunk' %}
 switchport
 switchport trunk encapsulation dot1q
 switchport mode trunk
 {% if iface.trunk_vlans and iface.trunk_vlans != 'null' %}
 switchport trunk allowed vlan {{ iface.trunk_vlans }}
 {% endif %}
 {% if iface.native_vlan and iface.native_vlan is not none and iface.native_vlan != 'null' %}
 switchport trunk native vlan {{ iface.native_vlan }}
 {% endif %}
 no shutdown

{# --- ROLE 4: ACCESS PORT --- #}
{% else %}
 switchport
 switchport mode access
 
 {% if iface.access_vlan and iface.access_vlan is not none and iface.access_vlan != 'null' %}
 switchport access vlan {{ iface.access_vlan }}
 {% endif %}
 
 {% if iface.voice_vlan and iface.voice_vlan is not none and iface.voice_vlan != 'null' %}
 switchport voice vlan {{ iface.voice_vlan }}
 {% endif %}
 spanning-tree portfast
 no shutdown

 {% if iface.auth_enabled %}
  authentication control-direction in
  authentication event fail retry 0 action authorize vlan {{ site_auth_fail_vlan }}
  authentication event server dead action authorize vlan {{ site_auth_server_dead_vlan }}
  authentication event server dead action authorize voice
  authentication event no-response action authorize vlan {{ site_auth_fail_vlan }}
  authentication periodic
  authentication timer reauthenticate {{ site_auth_reauth_timer | default(10000) }}
  mab
  dot1x pae authenticator
  dot1x timeout tx-period {{ site_dot1x_tx_period | default(9) }}
  dot1x timeout supp-timeout {{ site_dot1x_supp_timeout | default(15) }}
 {% endif %}

{% endif %}
!
{% endfor %}
