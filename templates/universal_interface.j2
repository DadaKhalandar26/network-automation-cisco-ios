{# --- MAP: Convert CIDR to Subnet Mask --- #}
{% set netmask_map = {
    '32': '255.255.255.255', '31': '255.255.255.254', '30': '255.255.255.252',
    '29': '255.255.255.248', '28': '255.255.255.240', '27': '255.255.255.224',
    '26': '255.255.255.192', '25': '255.255.255.128', '24': '255.255.255.0',
    '23': '255.255.254.0',   '22': '255.255.252.0',   '21': '255.255.248.0',
    '20': '255.255.240.0',   '19': '255.255.224.0',   '18': '255.255.192.0',
    '17': '255.255.128.0',   '16': '255.255.0.0',     '8':  '255.0.0.0'
} %}

{% for iface in interface_list %}
!
interface {{ iface.name }}
 {% if iface.description %}
 description {{ iface.description }}
 {% endif %}

{# ========================================================= #}
{# ROLE 1: ROUTED PORT (L3)                                  #}
{# ========================================================= #}
{% if iface.role == 'routed' %}
 {# FIX: Skip 'no switchport' only for Core Distribution Switches #}
 {% if 'device_roles_core_distribution_switch' not in group_names %}
 no switchport
 {% endif %}
 
 {% if iface.ipv4 %}
  {% set ip_parts = iface.ipv4.split('/') %}
  ip address {{ ip_parts[0] }} {{ netmask_map[ip_parts[1]] | default('255.255.255.0') }}
 {% endif %}
 no shutdown

{# ========================================================= #}
{# ROLE 2: SVI (Vlan Interface)                              #}
{# ========================================================= #}
{% elif iface.role == 'svi' %}
 {% if iface.ipv4 %}
  {% set ip_parts = iface.ipv4.split('/') %}
  ip address {{ ip_parts[0] }} {{ netmask_map[ip_parts[1]] | default('255.255.255.0') }}
 {% endif %}
 no shutdown

{# ========================================================= #}
{# ROLE 3: TRUNK / UPLINK                                    #}
{# ========================================================= #}
{% elif iface.role == 'trunk' %}
 switchport
 switchport trunk encapsulation dot1q
 switchport mode trunk
 {% if iface.trunk_vlans %}
 switchport trunk allowed vlan {{ iface.trunk_vlans }}
 {% endif %}
 {% if iface.native_vlan %}
 switchport trunk native vlan {{ iface.native_vlan }}
 {% endif %}
 no shutdown

{# ========================================================= #}
{# ROLE 4: ACCESS PORT (Default)                             #}
{# ========================================================= #}
{% else %}
 switchport
 switchport mode access
 
 {% if iface.access_vlan %}
 switchport access vlan {{ iface.access_vlan }}
 {% endif %}
 
 {% if iface.voice_vlan %}
 switchport voice vlan {{ iface.voice_vlan }}
 {% endif %}
 
 spanning-tree portfast
 no shutdown

 {% if iface.auth_enabled %}
  authentication control-direction in
  authentication event fail retry 0 action authorize vlan {{ site_auth_fail_vlan }}
  authentication event server dead action authorize vlan {{ site_auth_server_dead_vlan }}
  authentication event server dead action authorize voice
  authentication event no-response action authorize vlan {{ site_auth_fail_vlan }}
  authentication periodic
  authentication timer reauthenticate {{ site_auth_reauth_timer | default(3600) }}
  mab
  dot1x pae authenticator
  dot1x timeout tx-period {{ site_dot1x_tx_period | default(9) }}
  dot1x timeout supp-timeout {{ site_dot1x_supp_timeout | default(15) }}
 {% endif %}
 
 {% if iface.qos_profile != 'default' and qos_policy_maps[iface.qos_profile] is defined %}
  service-policy input {{ qos_policy_maps[iface.qos_profile].input }}
  service-policy output {{ qos_policy_maps[iface.qos_profile].output }}
 {% endif %}

{% endif %}
!
{% endfor %}
