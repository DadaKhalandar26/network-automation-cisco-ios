{% for iface in interface_list %}
!
interface {{ iface.name }}
 {% if iface.description and iface.description | length > 0 %}
 description {{ iface.description }}
 {% endif %}

{# --- ROLE 1: ROUTED PORT (Layer 3) --- #}
{% if iface.ipv4 and 'Vlan' not in iface.name %}
 {# Try L3 config, but typically requires L3 image #}
 no switchport
 ip address {{ iface.ipv4.split('/')[0] }} 255.255.255.0
 no shutdown

{# --- ROLE 2: SVI (Vlan Interface) --- #}
{% elif iface.ipv4 and 'Vlan' in iface.name %}
 ip address {{ iface.ipv4.split('/')[0] }} 255.255.255.0
 no shutdown

{# --- ROLE 3: TRUNK / UPLINK --- #}
{% elif iface.mode == 'tagged' or iface.mode == 'trunk' %}
 switchport
 switchport trunk encapsulation dot1q
 switchport mode trunk
 {% if iface.trunk_vlans and iface.trunk_vlans != 'null' %}
 switchport trunk allowed vlan {{ iface.trunk_vlans }}
 {% endif %}
 {% if iface.native_vlan and iface.native_vlan is not none and iface.native_vlan != 'null' %}
 switchport trunk native vlan {{ iface.native_vlan }}
 {% endif %}
 no shutdown

{# --- ROLE 4: ACCESS PORT --- #}
{% else %}
 switchport
 switchport mode access
 
 {% if iface.access_vlan and iface.access_vlan is not none and iface.access_vlan != 'null' %}
 switchport access vlan {{ iface.access_vlan }}
 {% endif %}
 
 {% if iface.voice_vlan and iface.voice_vlan is not none and iface.voice_vlan != 'null' %}
 switchport voice vlan {{ iface.voice_vlan }}
 {% endif %}
 
 device-tracking attach-policy {{ site_tracking_policy | default('SSC_IPDT') }}
 spanning-tree portfast
 no shutdown

 {% if iface.auth_enabled %}
  authentication control-direction in
  authentication event fail retry 0 action authorize vlan {{ site_auth_fail_vlan }}
  authentication event server dead action authorize vlan {{ site_auth_server_dead_vlan }}
  authentication event server dead action authorize voice
  authentication event no-response action authorize vlan {{ site_auth_fail_vlan }}
  authentication event server alive action reinitialize
  authentication host-mode multi-domain
  authentication port-control auto
  authentication periodic
  authentication timer reauthenticate {{ site_auth_reauth_timer | default(3600) }}
  mab
  snmp trap mac-notification change added
  snmp trap mac-notification change removed
  dot1x pae authenticator
  dot1x timeout tx-period {{ site_dot1x_tx_period | default(9) }}
  dot1x timeout supp-timeout {{ site_dot1x_supp_timeout | default(15) }}
 {% endif %}
 
 {% if iface.qos_profile is defined and qos_policy_maps is defined and iface.qos_profile in qos_policy_maps %}
  service-policy input {{ qos_policy_maps[iface.qos_profile].input }}
  service-policy output {{ qos_policy_maps[iface.qos_profile].output }}
 {% endif %}

{% endif %}
!
{% endfor %}
