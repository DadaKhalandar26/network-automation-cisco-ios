---
# PASS 1: Prepare Interface State (Mode & Encapsulation)
# We execute this BEFORE the template to ensure the port accepts the commands.
- name: "Pass 1: Enforce Interface Modes"
  cisco.ios.ios_config:
    lines:
      # 1. Force port to Layer 2 (Fixes 'Invalid input' on Core Switches)
      - switchport
      
      # 2. Force Encapsulation (Fixes 'Auto' error on trunks)
      - "{% if item.mode == 'trunk' or item.mode == 'tagged' %}switchport trunk encapsulation dot1q{% endif %}"
      
      # 3. Apply Mode
      - switchport mode {{ item.mode }}
      
      # 4. Apply Portfast (Safe for access ports)
      - "{% if item.mode == 'access' %}spanning-tree portfast{% endif %}"
    parents: "interface {{ item.name }}"
  loop: "{{ interface_list }}"
  when: 
    - item.mode is defined 
    - item.mode in ['access', 'trunk', 'tagged']
    - "'Vlan' not in item.name"
  ignore_errors: yes # Ignore if already configured correctly

# PASS 2: Apply Complete Configuration
- name: "Pass 2: Apply Full Configuration Template"
  cisco.ios.ios_config:
    src: "universal_interface.j2"
  register: deploy_result

- name: Display Interface Changes
  debug:
    var: deploy_result.updates
