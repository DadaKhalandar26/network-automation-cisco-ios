---
# ============================================================
# Upload Cisco IOS backup to SFTP server
# - Tries key-based SSH first
# - Falls back to password using expect
# ============================================================

- name: Check backup directory exists via SFTP cd
  ansible.builtin.expect:
    command: >
      sftp -o BatchMode=yes
           -o StrictHostKeyChecking=no
           -o UserKnownHostsFile=/dev/null
           {{ sftp_username }}@{{ sftp_host }}
    responses:
      sftp>:
        - "cd ios/backups/{{ inventory_hostname }}"
        - "pwd"
        - "bye"
  delegate_to: "{{ sftp_delegate | default('localhost') }}"
  register: sftp_cd_check
  changed_when: false
  failed_when: false

- name: Create backup directory via SFTP
  ansible.builtin.expect:
    command: >
      sftp -o StrictHostKeyChecking=no
           -o UserKnownHostsFile=/dev/null
           {{ sftp_username }}@{{ sftp_host }}
    responses:
      (?i)password: "{{ sftp_password }}"
      sftp>:
        - "mkdir backups/{{ inventory_hostname }}"
        - "bye"
  delegate_to: "{{ sftp_delegate | default('localhost') }}"
  register: sftp_mkdir_result
  failed_when: sftp_mkdir_result.rc != 0

- name: Check backup directory exists via SFTP cd
  ansible.builtin.expect:
    command: >
      sftp -o BatchMode=yes
           -o StrictHostKeyChecking=no
           -o UserKnownHostsFile=/dev/null
           {{ sftp_username }}@{{ sftp_host }}
    responses:
      sftp>:
        - "cd ios/backups/{{ inventory_hostname }}"
        - "pwd"
        - "bye"
  delegate_to: "{{ sftp_delegate | default('localhost') }}"
  register: sftp_cd_check
  changed_when: false
  failed_when: false

- name: Fail if remote backup directory still missing
  ansible.builtin.fail:
    msg: >
      Remote directory /ios/backups/{{ inventory_hostname }}/
      does not exist and could not be created on {{ sftp_host }}
  when: remote_dir_check_final.stdout is defined and
        remote_dir_check_final.stdout.find('present') == -1

- name: Upload config backup to SFTP server using password (expect)
  ansible.builtin.expect:
    command: >
      sftp -o StrictHostKeyChecking=no
           -o UserKnownHostsFile=/dev/null
           {{ sftp_username }}@{{ sftp_host }}:/ios/backups/{{ inventory_hostname }}/
    responses:
      (?i)password: "{{ sftp_password }}"
      sftp>:
        - "put {{ backup_result.backup_path }}"
        - "bye"
  delegate_to: "{{ sftp_delegate | default('localhost') }}"
  register: sftp_expect_result
  failed_when: sftp_expect_result.rc != 0
