---
- name: List backup files on SFTP server
  ansible.builtin.expect:
    command: >
      sftp
      -o StrictHostKeyChecking=no
      -o UserKnownHostsFile=/dev/null
      {{ sftp_username }}@{{ sftp_host }}
    responses:
      (?i)password: "{{ sftp_password }}"
      sftp>:
        - "cd /ios/backups/"
        - "ls"
        - "bye"
  register: sftp_list
  delegate_to: localhost

# Extract only .cfg files (ignore all other garbage)
- name: Extract only .cfg files from SFTP output
  set_fact:
    sftp_cfg_files: >-
      {{
        sftp_list.stdout_lines
        | select('search', '\\.cfg$')
        | list
      }}

# Select the latest backup for this device
- name: Extract latest backup filename
  set_fact:
    latest_backup: >-
      {{
        sftp_cfg_files
        | select('match', inventory_hostname)
        | sort
        | last
      }}

- name: Fail if no backup exists
  fail:
    msg: "No backup found for {{ inventory_hostname }} on SFTP server"
  when: latest_backup is not defined or latest_backup == ""

- name: Download latest backup file
  ansible.builtin.expect:
    command: >
      sftp
      -o StrictHostKeyChecking=no
      -o UserKnownHostsFile=/dev/null
      {{ sftp_username }}@{{ sftp_host }}
    responses:
      (?i)password: "{{ sftp_password }}"
      sftp>:
        - "cd /ios/backups/"
        - "get {{ latest_backup }} /tmp/{{ latest_backup }}"
        - "bye"
  delegate_to: localhost
