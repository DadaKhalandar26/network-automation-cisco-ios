- name: List hostname-specific files on SFTP
  ansible.builtin.expect:
    command: >
      sftp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null
      {{ sftp_username }}@{{ sftp_host }}
    responses:
      (?i)password: "{{ sftp_password }}"
      sftp>:
        - "cd /ios/backups/"
        - "ls {{ inventory_hostname }}*"
        - "bye"
  register: sftp_list
  delegate_to: localhost

- name: Extract lines that contain .cfg
  set_fact:
    sftp_cfg_lines: >-
      {{ sftp_list.stdout_lines | select('search', '\\.cfg$') | list }}

- name: Split lines into individual filenames and normalize
  set_fact:
    sftp_cfg_files: >-
      {{
        sftp_cfg_lines
        | map('split')            # split multi-column lines into words
        | list
        | sum(start=[])           # flatten list of lists
        | map('trim')             # remove surrounding whitespace
        | reject('equalto', '')   # drop empty tokens
        | list
      }}

- name: Debug file list
  debug:
    var: sftp_cfg_files

- name: Select latest backup matching this host
  set_fact:
    latest_backup: >-
      {{
        (sftp_cfg_files
         | select('search', inventory_hostname)   # substring match
         | sort
         | list
         | last) | default('')
      }}

- name: If no hostname match, optionally select most recent overall
  set_fact:
    latest_backup: >-
      {{
        (latest_backup if latest_backup != ''
         else (sftp_cfg_files | sort | last | default('')))
      }}

- name: Fail if no backup exists
  fail:
    msg: "No backup found for {{ inventory_hostname }} on SFTP server; sftp_cfg_files={{ sftp_cfg_files }}"
  when: latest_backup == ""

- name: Debug selected backup
  debug:
    msg: "Selected latest backup: {{ latest_backup }}"

- name: Download latest backup file
  ansible.builtin.expect:
    command: >
      sftp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null
      {{ sftp_username }}@{{ sftp_host }}
    responses:
      (?i)password: "{{ sftp_password }}"
      sftp>:
        - "cd /ios/backups/"
        - "get {{ latest_backup }} /tmp/{{ latest_backup }}"
        - "bye"
  delegate_to: localhost
