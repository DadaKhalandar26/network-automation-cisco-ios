---
# ---------------------------------------------------------
# STEP 1 — Ensure download directory exists
# ---------------------------------------------------------
- name: Ensure download directory exists on controller
  file:
    path: "{{ download_dest_dir | default('/tmp') }}"
    state: directory
    mode: "01777"
  delegate_to: localhost

# ---------------------------------------------------------
# STEP 2 — List files from host-specific SFTP directory
# ---------------------------------------------------------
- name: List backup files on SFTP server (host-specific directory)
  ansible.builtin.shell: >
    printf "cd {{ sftp_path | default('/ios/backups') }}/{{ inventory_hostname }}\nls -1\nbye\n" |
    sshpass -p '{{ sftp_password }}' sftp
    -oBatchMode=no
    -oStrictHostKeyChecking=no
    -oUserKnownHostsFile=/dev/null
    {{ sftp_username }}@{{ sftp_host }}
  register: sftp_list
  delegate_to: localhost
  changed_when: false

- debug:
    var: sftp_list.stdout_lines

# ---------------------------------------------------------
# STEP 3 — Extract clean .cfg filenames
# ---------------------------------------------------------
- name: Flatten stdout_lines
  set_fact:
    sftp_raw: "{{ sftp_list.stdout_lines | default([]) | list }}"

- name: Tokenize output
  set_fact:
    sftp_tokens: >-
      {{ (sftp_raw
          | map('split')
          | list
          | sum(start=[])
          | map('trim')
          | reject('equalto','')
          | list) }}

- name: Keep only .cfg files
  set_fact:
    cfg_files: "{{ sftp_tokens | select('search','\\.cfg$') | list }}"

- debug:
    var: cfg_files

- name: Fail if no backup files found
  fail:
    msg: "No backup files found in /ios/backups/{{ inventory_hostname }}/"
  when: cfg_files | length == 0

# ---------------------------------------------------------
# STEP 4 — Select latest backup (sorted alphabetically)
# ---------------------------------------------------------
- name: Select latest backup
  set_fact:
    latest_backup: "{{ cfg_files | sort | last }}"

- debug:
    var: latest_backup

# ---------------------------------------------------------
# STEP 5 — Download file
# ---------------------------------------------------------
- name: Download latest backup file
  ansible.builtin.shell: >
    printf "cd {{ sftp_path | default('/ios/backups') }}/{{ inventory_hostname }}\nget {{ latest_backup }} {{ download_dest_dir | default('/tmp') }}/{{ latest_backup }}\nbye\n" |
    sshpass -p '{{ sftp_password }}' sftp
    -oBatchMode=no
    -oStrictHostKeyChecking=no
    -oUserKnownHostsFile=/dev/null
    {{ sftp_username }}@{{ sftp_host }}
  register: download_status
  delegate_to: localhost
  changed_when: "'Fetching' in download_status.stdout"

- name: Confirm file exists
  stat:
    path: "{{ download_dest_dir | default('/tmp') }}/{{ latest_backup }}"
  register: downloaded_stat
  delegate_to: localhost

- debug:
    msg:
      - "Downloaded: {{ downloaded_stat.stat.exists }}"
      - "Path: {{ download_dest_dir | default('/tmp') }}/{{ latest_backup }}"

- name: Set backup filename and path for apply stage
  set_fact:
    backup_filename: "{{ latest_backup }}"
    backup_full_path: "/tmp/{{ latest_backup }}"

