---
- name: Enable SFTP server on device
  cisco.ios.ios_config:
    lines:
      - ip scp server enable

- name: Upload backup file to device flash
  cisco.ios.ios_file:
    src: "{{ backup_full_path }}"
    dest: "flash:{{ backup_filename }}"
    protocol: scp
  vars:
    ansible_command_timeout: 120

- name: Verify uploaded file exists
  cisco.ios.ios_command:
    commands:
      - "dir flash:{{ backup_filename }}"
  register: flash_check

- name: Fail if file not found on flash
  fail:
    msg: "Backup file {{ backup_filename }} not found on device flash!"
  when: "'No such file' in flash_check.stdout[0]"

- name: Restore config using configure replace
  cisco.ios.ios_command:
    commands:
      - "configure replace flash:{{ backup_filename }} force"
  register: restore_output

- debug:
    var: restore_output.stdout_lines
