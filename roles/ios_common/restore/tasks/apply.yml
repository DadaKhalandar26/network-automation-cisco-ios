---
- name: Set controller_ip
  set_fact:
    controller_ip: "192.168.29.51"
# STEP 1 — Build HTTPS URL for the backup file
- name: Build HTTPS URL for backup file
  set_fact:
    backup_https_url: "https://{{ controller_ip }}/files/{{ backup_filename }}"

# STEP 2 — Copy backup file to device flash using HTTPS
- name: Copy backup file to device flash using HTTPS
  cisco.ios.ios_command:
    commands:
      - "copy {{ backup_https_url }} bootflash:{{ backup_filename }}"
  vars:
    ansible_command_timeout: 300
  register: https_copy

- debug:
    var: https_copy.stdout_lines

# STEP 3 — Verify uploaded file exists
- name: Verify uploaded file exists
  cisco.ios.ios_command:
    commands:
      - "dir bootflash: | include {{ backup_filename }}"
  register: flash_check

- name: Fail if file not found on flash
  fail:
    msg: "Backup file {{ backup_filename }} not found on device bootflash!"
  when: flash_check.stdout[0] is not search(backup_filename)

# STEP 4 — Restore configuration using configure replace
- name: Restore config using configure replace
  cisco.ios.ios_command:
    commands:
      - "configure replace bootflash:{{ backup_filename }} force"
  register: restore_output

- debug:
    var: restore_output.stdout_lines
